name: KM CICD Workflow
on:
  push:
    branches:
      - 'v[0-9]+.[0-9]'
    #push:
      #branches:
        #- 'v[0-9]+.[0-9]'

jobs:
    CICD_Workflow:
        runs-on: ubuntu-latest

        steps:
        - name: checkout my source
          id: check_out_mysource
          uses: actions/checkout@v4
        
        - name: trivy scan
          id: trivy_scan
          uses: aquasecurity/trivy-action@master
          with:
            scan-type: fs
            scan-ref: . #kianmun/fortunes:latest
            format: table
            severity: CRITICAL, HIGH
            #outfile: scan_results.txt
            output: trivyScan.txt
        
        - name: check trivy scan
          id: check_trivy_scan
          run: |
            if [ -f "trivyScan.txt" ] && grep -q "Vulnerabilities detected: 0" "trivyScan.txt"; then
              echo "Trivy Scan Successful"
            else
              echo "Trivy Scan Failed"
              exit 1
            fi
        
        - name: Slack Notification
          id: slack_notification
          uses: rtCamp/action-slack-notify@v2
          env:
            SLACK_CHANNEL: general
            SLACK_COLOR: ${{ job.status }} 
            SLACK_MESSAGE: ${{ steps.trivy_scan.outputs.check_trivy_scan.message }}
            SLACK_TITLE: Scan Results
            SLACK_USERNAME: KianMun
            SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_TEST }}
           

#To define scope for to_slack